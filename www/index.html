<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>CC'ed</title>
</head>

<body></body>

<script id="login-tpl" type="text/x-jQuery-tmpl">
  <h1 id="CCED">CCed</h1>
  <p>Log In</p>
  <form id = "login-form">
    Username:<br>
    <input type="text" name="username"><br/>
    Password:<br>
    <input type="password" name="password">
  </form>
  <div id = "login-button"><p class="button" >Log In</p></div>
  <p class="button" data-href="employerOrStudent">Sign Up</p>
</script>

<script id="signup-employer-student-tpl" type="text/x-jQuery-tmpl">
  <form>
    <p class= "button" data-href="signUpEmployer">Employer</p>
    <p class= "button" data-href="signUpStudent">Student</p>
  </form>
</script>

<script id="signup-employer-tpl" type="text/x-jQuery-tmpl">
    <form id="employer-signup-form">
      First Name:<br>
      <input type="text" name="firstname"><br>
      Last Name:<br>
      <input type="text" name="lastname"><br>
      Email:<br>
      <input type="text" name="email"><br>
      Username:<br>
      <input type="text" name="username"><br>
      Password:<br>
      <input type="text" name="password"><br>
      <p class= "button" id="employer-signup">Sign Up</p>
    </form>
</script>

<script id="signup-student-tpl" type="text/x-jQuery-tmpl">
  <form id="student-signup-form">
    First Name:<br>
    <input type="text" name="firstname"><br>
    Last Name:<br>
    <input type="text" name="lastname"><br>
    Email:<br>
    <input type="text" name="email"><br>
    Username:<br>
    <input type="text" name="username"><br>
    Password:<br>
    <input type="text" name="password"><br>
    <p class= "button" id="student-signup">Sign Up</p>
  </form>
</script>

<script id = "student-map-tpl" type="text/x-jQuery-tmpl">
  <p class= "button" id = "log-out">Log out</p>
  <p class= "button" data-href="studentMap">map</p>
  <p class= "button" data-href="studentUpcoming">upcoming</p>
  <p class= "button" data-href="studentTimesheet">timesheet</p>

  <div id="googleMap" style="width:100%;height:400px;"></div>

  <p>opportunities</p>

  <ul class="opportunities"><ul>
</script>
<script>

</script>

<script id = "student-upcoming-tpl" type="text/x-jQuery-tmpl">
  <p class= "button" id = "log-out">Log out</p>
  <p class= "button" data-href="studentMap">map</p>
  <p class= "button" data-href="studentUpcoming">upcoming</p>
  <p class= "button" data-href="studentTimesheet">timesheet</p>
</script>

<script id = "student-timesheet-tpl" type="text/x-jQuery-tmpl">
  <p class= "button" id = "log-out">Log out</p>
  <p class= "button" data-href="studentMap">map</p>
  <p class= "button" data-href="studentUpcoming">upcoming</p>
  <p class= "button" data-href="studentTimesheet">timesheet</p>
</script>

<script id = "employer-schedule-tpl" type="text/x-jQuery-tmpl">
  <p class= "button" id = "log-out">Log out</p>
  <p class= "button" data-href="employerSchedule">Schedule</p>
  <p class= "button" data-href="employerRoster">Roster</p>

  <form id = "employer-events">
    Opportunity name:<br>
    <input type="text" name="events"><br>
    Time:<br>
    <input type="text" name="time"><br>
    Zip Code:<br>
    <input type="text" name="zipCode"><br>
    <br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Sunday"> Sunday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Monday"> Monday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Tuesday"> Tuesday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Wednesday"> Wednesday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Thursday"> Thursday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Friday"> Friday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Saturday"> Saturday<br>
    <input type="hidden" name="employer" value="">
    <p id= "add-button">add</p>
  </form>
</script>

<script id = "employer-roster-tpl" type="text/x-jQuery-tmpl">
  <p class= "button" id = "log-out">Log out</p>
  <p class= "button" data-href="employerSchedule">Schedule</p>
  <p class= "button" data-href="employerRoster">Roster</p>
</script>

<script type="text/javascript" src="http://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjNWiW2AT7db_A64_JZIOG0_z_6gjmSfc"></script>
<script type="text/javascript" src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript">
    app.initialize();

    // Set our template variables from our script tags
    var templates = {
      login: $('#login-tpl').html(),
      employerOrStudent: $('#signup-employer-student-tpl').html(),
      signUpEmployer: $('#signup-employer-tpl').html(),
      signUpStudent: $('#signup-student-tpl').html(),
      studentMap: $('#student-map-tpl').html(),
      studentUpcoming: $('#student-upcoming-tpl').html(),
      studentTimesheet: $('#student-timesheet-tpl').html(),
      employerSchedule: $('#employer-schedule-tpl').html(),
      employerRoster: $('#employer-roster-tpl').html()
    };

    var pageLoadFunctions = {
      studentMap: function() {
        window.navigator.geolocation.getCurrentPosition(function(position) {

          var map = new google.maps.Map(document.getElementById("googleMap"), {
            center: new google.maps.LatLng(position.coords.latitude,position.coords.longitude),
            zoom: 5,
          });
        });

        // load opportunities
        var events = firebase.database().ref("Events");
        events.once('value', function(snapshot) {
          snapshot.forEach(function(childSnapshot) {
            appendEvent(childSnapshot.key, childSnapshot.val());
          });
        });
      },
      employerSchedule: function(employerUsername) {
        $('input[name="employer"]').val(employerUsername);
      }
    };

    function appendEvent(eventID, eventData) {
      var registerEventButton = $('<input type="button" value="Sign Up" data-eventid="'+eventID+'" />');
      registerEventButton.on('click', function(event) {
        event.preventDefault();
        writeRegisteredStudentData($(this).data().eventid, window.sessionStorage.getItem('userID'));
      });

      var event = $('<li></li>').append('<p>'+eventData.employer+' - ' +eventData.name+ '</p>');
      var eventInfo = $('<ol></ol>').
        append('<li>'+eventData.date.join(', ')+'</li>').
        append('<li>'+eventData.time+'</li>').
        append('<li>'+eventData.zip+'</li>').
        append($('<li></li>').append(registerEventButton));
      $('.opportunities').append(event).append(eventInfo);
    }

    function goToPage(template, data) {
      $('body').html(templates[template]);

      // Check if we have anything to do on page load
      if (pageLoadFunctions[template]) {
        pageLoadFunctions[template](data);
      }
    }

    // Render homepage
    goToPage('login');

    // Navigation button click
    $('body').on('click', '.button', function(event) {
      var template = $(event.target).attr('data-href');
      goToPage(template);
    });

    // Student signup click
    $('body').on('click', '#student-signup', function() {
      var form = $('#student-signup-form');
      var firstName= form.find('input[name=firstname]').val();
      var lastName= form.find('input[name=lastname]').val();
      var email= form.find('input[name=email]').val();
      var username= form.find('input[name=username]').val();
      var password= form.find('input[name=password]').val();

      // Create student in firebase
      writeStudentData(username, email, firstName, lastName, password);

      goToPage('studentMap');
    });

    $('body').on('click', '#employer-signup', function() {
      var form = $('#employer-signup-form');
      var firstName= form.find('input[name=firstname]').val();
      var lastName= form.find('input[name=lastname]').val();
      var email= form.find('input[name=email]').val();
      var username= form.find('input[name=username]').val();
      var password= form.find('input[name=password]').val();

      writeEmployerData(username, email, firstName, lastName, password);

      goToPage('employerSchedule', username);
    });

    $('body').on('click', '#login-button', function() {
      var form = $('#login-form');
      var username= form.find('input[name=username]').val();
      var password= form.find('input[name=password]').val();

      // log in for students
      var studentsRef = firebase.database().ref("Students");
      studentsRef.orderByChild('username').equalTo(username).limitToFirst(1).once('value', function(snapshot) {
        if (snapshot.val() != null) {
          snapshot.forEach(function(studentsSnapshot) {
            if (studentsSnapshot.val().password == password)  {
              window.sessionStorage.setItem('userID', studentsSnapshot.key);
              goToPage('studentMap');
            }
          });
        }
      });

      // log in for employer
      var employerRef = firebase.database().ref("Employers");
      employerRef.orderByChild('username').equalTo(username).limitToFirst(1).once('value', function(snapshot) {
        var userData = snapshot.val();
        if (userData != null) {
          snapshot.forEach(function(employerSnapshot) {
            if (employerSnapshot.val().password == password) {
              window.sessionStorage.setItem('userID', employerSnapshot.key);
              goToPage('employerSchedule', username);
            }
          });
        }
      });
    });

      $('body').on('click', '#log-out', function() {
        goToPage("login")
      });

      $('body').on('click', '#add-button', function() {
        var form = $('#employer-events');
        var addEvent= form.find('input[name=events]').val();

        var checkedValues = $('.daysOfWeek:checked').map(function(index, value) {
          return $(value).val();
        }).get();


        var addTime = form.find('input[name=time]').val();
        var addZip = form.find('input[name=zipCode]').val();
        var employer = form.find('input[name="employer"]').val();

        writeEventData(addEvent, checkedValues, addTime, addZip, employer);
      });
</script>

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAqOiEtrBxFAFvG9O1tiUk8WXiXUZX2shk",
    authDomain: "community-connected-13553.firebaseapp.com",
    databaseURL: "https://community-connected-13553.firebaseio.com",
    projectId: "community-connected-13553",
    storageBucket: "community-connected-13553.appspot.com",
    messagingSenderId: "12935296391"
  };
  firebase.initializeApp(config);

  function writeStudentData(username, email, firstName, lastName, password) {
    firebase.database().ref('Students').push().set({
      username: username,
      email: email,
      firstName: firstName,
      lastName: lastName,
      password: password
    });
  }

  function writeEmployerData(username, email, firstName, lastName, password) {
    firebase.database().ref('Employers').push().set({
      username: username,
      email: email,
      firstName: firstName,
      lastName: lastName,
      password: password
    });
  }

  function writeEventData(employerEvent, date, time, zip, employer) {
    firebase.database().ref('Events').push().set({
      name: employerEvent,
      date: date,
      time: time,
      zip: zip,
      employer: employer
    });
  }

  function writeRegisteredStudentData(eventID, studentID) {
    firebase.database().ref('RegisteredEvents').push().set({
      eventID: eventID,
      studentID: studentID
    });
  }
</script>

</html>
