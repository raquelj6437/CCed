<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
    <!--<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />-->

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>CC'ed</title>
</head>

<body></body>

<script id="login-tpl" type="text/x-jQuery-tmpl">
<br>
<br>
<br>
  <h1 id = "smd">CC&#39;<span id="pus">ed</span></h1>
  <form id = "login-form">
    <input class = "loginInput inputUser" type="text" name="username" placeholder="Username"><br/>
    <input class = "loginInput inputPass" type="password" name="password" placeholder="Password">
  </form>
  <br>
  <br>
  <div id = "login-button"><button class="button login login-button">Login</button></div>
  <br>
  <button class="button login signup-button" data-href="employerOrStudent">Sign Up</button>
</script>

<script id="signup-employer-student-tpl" type="text/x-jQuery-tmpl">
  <form>
    <button class= "button employerButton" data-href="signUpEmployer">Employer</button>
    <button class= "button schoolButton" data-href="signUpSchool">School</button>
  </form>
</script>

<script id="signup-employer-tpl" type="text/x-jQuery-tmpl">
    <form id="employer-signup-form">
    <h1 id = "smd">CC&#39;<span id="pus">ed</span></h1>
    <input class= "signUpInput" type="text" name="firstname" placeholder="First Name"><br>
    <input class= "signUpInput" type="text" name="lastname" placeholder="Last Name"><br>
    <input class= "signUpInput" type="text" name="email" placeholder="Email"><br>
    <input class= "signUpInput" type="text" name="username" placeholder="Username"><br>
    <input class= "signUpInput" type="text" name="password" placeholder="Password"><br>
    <br>
    <br>
    <br>
    <button class= "button signUpButton" id="employer-signup">Sign Up</button>
    </form>
</script>

<script id="signup-school-tpl" type="text/x-jQuery-tmpl">
  <form id = "school-signup-form">
    <h1 id = "smd">CC&#39;<span id="pus">ed</span></h1>
    <input class= "signUpInput" type="text" name="nameOfSchool" placeholder="Name of School"><br>
    <input class= "signUpInput" type="text" name="numberOfStudents" placeholder="Number of Students"><br>
    <input class= "signUpInput" type="text" name="email" placeholder="Email"><br>
    <input class= "signUpInput" type="text" name="phoneNumber" placeholder="Phone Number"><br>
    <br>
    <br>
    <br>
    <br>
    <button class= "button signUpButton" id="school-signup" data-href="contactPage">Continue</button>
  </form>
</script>

<script id="contact-page-tpl" type="text/x-jQuery-tmpl">
  <form>
    <br>
    <br>
    <br>
    <h1 id = "smd">CC&#39;<span id="pus">ed</span></h1>
    <p id= "contactPage"> We will get back to you within 24 hours. <p>
  </form>
</script>

<script id = "student-map-tpl" type="text/x-jQuery-tmpl">
  <br style="background-color:white;">
  <link href="https://fonts.googleapis.com/css?family=Encode+Sans+Semi+Condensed" rel="stylesheet">

  <div id="googleMap" style="width:100%;height:91%;"></div>

  <button class= "button studentButtons" id = "log-out">Log out</button>
  <a href="#events-link"><button class= "button studentButtons">Events</button></a>
  <button class= "button studentButtons" data-href="studentTimesheet">Timesheet</button>

  <br>
  <br>
  <br>
  <div id="events-link">
    <br>
    <div class="upcoming">
      <p class = "titles">Upcoming Opportunities</p>
      <ol class="upcoming-opportunities"></ol>
    </div>

    <div class="available">
      <p class = "titles">Available Opportunities</p>
      <ol class="available-opportunities"></ol>
    </div>
  </div>

  <button onclick="topFunction()" id="myBtn" title="Go to map">Map</button>
</script>

<script>
  // When the user scrolls down 20px from the top of the document, show the button
  window.onscroll = function() {scrollFunction()};

  function scrollFunction() {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
          document.getElementById("myBtn").style.display = "block";
      } else {
          document.getElementById("myBtn").style.display = "none";
      }
  }

  // When the user clicks on the button, scroll to the top of the document
  function topFunction() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
  }
</script>


<script id = "student-timesheet-tpl" type="text/x-jQuery-tmpl">
  <br style="background-color:white;">
  <br>
  <button class= "button studentButtons" id = "log-out">Log out</button>
  <button class= "button studentButtons" data-href="studentMap">Map</button>
  <button class= "button studentButtons" data-href="studentTimesheet">Timesheet</button>
</script>

<script id = "employer-schedule-tpl" type="text/x-jQuery-tmpl">
  <br style="background-color:white;">
  <br>
  <button class= "button employerButtons" id = "log-out">Log out</button>
  <button class= "button employerButtons" data-href="employerRoster">Roster</button><br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <form id = "employer-events" style="clear:both">
    <input class= "eventInput" type="text" name="events" placeholder="Opportunity Name"><br>
    <input class= "eventInput" type="text" name="time" placeholder="Time"><br>
    <input class= "eventInput" type="text" name="zipCode" placeholder="Address"><br>
    <br>
    <br>
    <p class = "middleTags">Choose Reccuring Days of Event</p>

    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Sunday"> Sunday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Monday"> Monday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Tuesday"> Tuesday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Wednesday"> Wednesday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Thursday"> Thursday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Friday"> Friday<br>
    <input type="checkbox" class="daysOfWeek" name="daysOfWeek" value="Saturday"> Saturday<br>
    <input type="hidden" name="employer" value="">
    <br>
    <button class= "addButton"id= "add-button">Add</button>

    <p class="middleTags"> Created Events </p>
  </form>
</script>

<script id = "employer-roster-tpl" type="text/x-jQuery-tmpl">
<br>
<br>
<button class= "button employerButtons" id = "log-out">Log out</button>
<button class= "button employerButtons" data-href="employerSchedule">Schedule</button>

  <table id="student-roster">
    <thead>
      <tr>
        <th>First name</td>
        <th>Last name</td>
        <th>E-mail</td>
        <th>Hours</td>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</script>

<script type="text/javascript" src="http://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjNWiW2AT7db_A64_JZIOG0_z_6gjmSfc"></script>
<script type="text/javascript" src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAqOiEtrBxFAFvG9O1tiUk8WXiXUZX2shk",
    authDomain: "community-connected-13553.firebaseapp.com",
    databaseURL: "https://community-connected-13553.firebaseio.com",
    projectId: "community-connected-13553",
    storageBucket: "community-connected-13553.appspot.com",
    messagingSenderId: "12935296391"
  };
  firebase.initializeApp(config);

  function writeSchoolData(nameOfSchool, numberOfStudents, email, phoneNumber) {
    firebase.database().ref('Schools').push().set({
      nameOfSchool:nameOfSchool,
      numberOfStudents:numberOfStudents,
      email:email,
      phoneNumber:phoneNumber
    });
  }

  function writeEmployerData(username, email, firstName, lastName, password) {
    var employerRef = firebase.database().ref('Employers').push();
    employerRef.set({
      username: username,
      email: email,
      firstName: firstName,
      lastName: lastName,
      password: password
    });
    return employerRef.key;
  }

  function writeEventData(employerEvent, date, time, zip, employerName, employerID) {
    firebase.database().ref('Events').push().set({
      name: employerEvent,
      date: date,
      time: time,
      zip: zip,
      employer: employerName,
      employerID: employerID
    });
  }

  function writeRegisteredStudentData(eventID, studentID) {
    firebase.database().ref('RegisteredEvents').push().set({
      eventID: eventID,
      studentID: studentID
    });
  }
</script>
<script type="text/javascript">
    app.initialize();

    // Set our template variables from our script tags
    var templates = {
      login: $('#login-tpl').html(),
      employerOrStudent: $('#signup-employer-student-tpl').html(),
      signUpEmployer: $('#signup-employer-tpl').html(),
      signUpSchool: $('#signup-school-tpl').html(),
      contactPage: $('#contact-page-tpl').html(),
      studentMap: $('#student-map-tpl').html(),
      studentUpcoming: $('#student-upcoming-tpl').html(),
      studentTimesheet: $('#student-timesheet-tpl').html(),
      employerSchedule: $('#employer-schedule-tpl').html(),
      employerRoster: $('#employer-roster-tpl').html()
    };

    var pageLoadFunctions = {
      studentMap: function() {
        
        // Fetch our position as a promise
        window.locationPromise
          .then(function(position) {
            var map = new google.maps.Map(document.getElementById("googleMap"), {
              center: new google.maps.LatLng(position.coords.latitude,position.coords.longitude),
              zoom: 17,
              mapTypeControl: false,
              scaleControl: false,
              streetViewControl: false,
              zoomControl: true
            });
        });

        // load upcoming opportunities
        firebase.database().ref('RegisteredEvents')
          .orderByChild('studentID')
          .equalTo(window.sessionStorage.getItem('userID'))
          .once('value', function(snapshot) {
            var results = snapshot.val() || {};
            var registeredEventIDs = [];
            for (var eventKey in results) {
              registeredEventIDs.push(results[eventKey].eventID);
              firebase.database().ref('Events/' + results[eventKey].eventID).once('value', function(snapshot) {
                appendUpcomingEvent(snapshot.val());
              });
            }

            // Load available opportunities
            firebase.database().ref('Events').once('value', function(snapshot) {
              snapshot.forEach(function(childSnapshot) {
                // Only append available event if not already registered for
                if (registeredEventIDs.indexOf(childSnapshot.key) === -1) {
                  appendAvailableEvent(childSnapshot.key, childSnapshot.val());
                }
              });
            });
          });  
      },
      employerSchedule: function(employer) {
        $('input[name="employerName"]').val(employer.name);
        $('input[name="employerID"').val(employer.id)
      },
      employerRoster: function() {
        var database = firebase.database();

        database.ref('Events').once('value', function(eventSnapshot) {
          eventSnapshot.forEach(function(event) {
            if (event.val().employerID === window.sessionStorage.getItem('userID')) {
              database.ref('RegisteredEvents').
                orderByChild('eventID').
                equalTo(event.key).
                limitToFirst(1).
                once('value', function(registeredEventSnapshot) {
                  if (registeredEventSnapshot.val() != null) {
                    registeredEventSnapshot.forEach(function(registeredEvent) {
                      database.ref('Students/' + registeredEvent.val().studentID).once('value', function(studentSnapshot) {
                        if (studentSnapshot.val() != null) {
                          //make ordered list for roster
                          var student = $('<tr></tr>').
                            append('<td>' +studentSnapshot.val().firstName+ '</td>').
                            append('<td>' +studentSnapshot.val().lastName+ '</td>').
                            append('<td>' +studentSnapshot.val().email+ '</td>');
                            // add student hours
                            // add button for employer to sign off on student
                          $('#student-roster tbody').append(student);
                        }
                      });
                    });
                  }
                });
            }
          });
        });
      }
    };

    function appendUpcomingEvent(eventData) {
      var event = $('<li></li>').append('<p>'+eventData.employerName+' - ' +eventData.name+ '</p>');
      var eventInfo = $('<ul></ul>');
      eventInfo
        .append('<li>'+eventData.date.join(', ')+'</li>')
        .append('<li>'+eventData.time+'</li>')
        .append('<li>'+eventData.zip+'</li>');
      event.append(eventInfo);
      $('.upcoming-opportunities').append(event);
    }

    function appendAvailableEvent(eventID, eventData) {
      var registerEventButton = $('<input type="button" value="Sign Up" data-eventid="'+eventID+'" />');
      registerEventButton.on('click', function(event) {
        event.preventDefault();
        // remove from DOM
        $('li#' + eventID).remove();
        // add to upcoming
        appendUpcomingEvent(eventData);
        // add to database
        writeRegisteredStudentData($(this).data().eventid, window.sessionStorage.getItem('userID'));
      });

      var event = $('<li id="' + eventID  + '"></li>').append('<p>'+eventData.employerName+' - ' +eventData.name+ '</p>');
      var eventInfo = $('<ul></ul>');
      eventInfo
        .append('<li>'+eventData.date.join(', ')+'</li>')
        .append('<li>'+eventData.time+'</li>')
        .append('<li>'+eventData.zip+'</li>')
        .append($('<p></p>').append(registerEventButton));
      event.append(eventInfo);
      $('.available-opportunities').append(event);
    }

    function goToPage(template, data) {
      $('body').html(templates[template]);

      // Check if we have anything to do on page load
      if (pageLoadFunctions[template]) {
        pageLoadFunctions[template](data);
      }
    }

    // Check if user is already logged in
    if (window.sessionStorage.userID) {
      if (window.sessionStorage.userType === 'student')  {
        goToPage('studentMap');
      } else if (window.sessionStorage.userType === 'employer') {
        goToPage('employerSchedule', { name: window.sessionStorage.username, id: window.sessionStorage.userID } );
      }
    } else {
      // Render homepage
      goToPage('login');
    }

    // Navigation button click
    $('body').on('click', '.button', function(event) {
      var template = $(event.target).attr('data-href');
      goToPage(template, { name: window.sessionStorage.getItem('username'), id: window.sessionStorage.getItem('userID') });
    });

    // Student signup click
    $('body').on('click', '#school-signup', function() {
      var form = $('#school-signup-form');
      var nameOfSchool= form.find('input[name=nameOfSchool]').val();
      var numberOfStudents= form.find('input[name=numberOfStudents]').val();
      var email= form.find('input[name=email]').val();
      var phoneNumber= form.find('input[name=phoneNumber]').val();

      // Create student in firebase
      writeSchoolData(nameOfSchool, numberOfStudents, email, phoneNumber);

      goToPage('contactPage');
    });

    $('body').on('click', '#employer-signup', function() {
      var form = $('#employer-signup-form');
      var firstName= form.find('input[name=firstname]').val();
      var lastName= form.find('input[name=lastname]').val();
      var email= form.find('input[name=email]').val();
      var username= form.find('input[name=username]').val();
      var password= form.find('input[name=password]').val();

      var employerID = writeEmployerData(username, email, firstName, lastName, password);

      goToPage('employerSchedule', { id: employerID, name: username });
    });

    $('body').on('click', '#login-button', function() {
      var form = $('#login-form');
      var username = form.find('input[name=username]').val();
      var password = form.find('input[name=password]').val();

      // log in for students
      var studentsRef = firebase.database().ref("Students");
      studentsRef.orderByChild('username').equalTo(username).limitToFirst(1).once('value', function(snapshot) {
        if (snapshot.val() != null) {
          snapshot.forEach(function(studentsSnapshot) {
            if (studentsSnapshot.val().password == password)  {
              window.sessionStorage.setItem('userID', studentsSnapshot.key);
              window.sessionStorage.setItem('username', username);
              window.sessionStorage.setItem('userType', 'student');
              goToPage('studentMap');
            }
          });
        }
      });

      // log in for employer
      var employerRef = firebase.database().ref("Employers");
      employerRef.orderByChild('username').equalTo(username).limitToFirst(1).once('value', function(snapshot) {
        var userData = snapshot.val();
        if (userData != null) {
          snapshot.forEach(function(employerSnapshot) {
            if (employerSnapshot.val().password == password) {
              window.sessionStorage.setItem('userID', employerSnapshot.key);
              window.sessionStorage.setItem('username', username);
              window.sessionStorage.setItem('userType', 'employer');
              goToPage('employerSchedule', { name: username, id: employerSnapshot.key } );
            }
          });
        }
      });
    });

      $('body').on('click', '#log-out', function() {
        goToPage("login");
        window.sessionStorage.clear();
      });

      $('body').on('click', '#add-button', function() {
        var form = $('#employer-events');
        var addEvent= form.find('input[name=events]').val();

        var checkedValues = $('.daysOfWeek:checked').map(function(index, value) {
          return $(value).val();
        }).get();


        var addTime = form.find('input[name=time]').val();
        var addZip = form.find('input[name=zipCode]').val();
        var employerName = form.find('input[name="employerName"]').val();
        var employerID = form.find('input[name="employerID"]').val();

        writeEventData(addEvent, checkedValues, addTime, addZip, employerName, employerID);
      });
</script>

</html>
